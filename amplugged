#!/bin/bash

echo ""
printf "\033[1m\033[36m####################################### \n"
printf "## AMPLICON SEQUENCING FULL PIPELINE ##\n"
printf "##  based on FASTQC and CRISPResso2  ##\n"
printf "#######################################\033[0m \n"
echo -e "\nAuthor: Alejandro La Greca PhD"
echo ""
date +"%T"
echo ""

## Importing functions
source scripts/file_setup
source scripts/qualityCheck
source scripts/run_crispresso2
source parameters.txt

## Checking user directives (input/output directories and files)
check_files "${RAW_DATA}"
check_dir "${OUT_DIR}"


### Set variables ###
FQC="${OUT_DIR}"/fastqc
CPR="${OUT_DIR}"/crispresso
QC=$(echo "${QUALITY_CHECK}" | tr '[:lower:]' '[:upper:]')
RM=$(echo "${RUN_MODE}" | tr '[:lower:]' '[:upper:]')
#####################



if [ "${QC}" == "YES" ]; then
	
	printf "\033[1m###################\n"
	printf "## QUALITY CHECK ##\n"
	printf "###################\033[0m \n"
	echo
	
	qualifastqc "${RAW_DATA}" "${FQC}"

elif [ "${QC}" == "ONLY" ]; then
	
	printf "\033[1m###################\n"
	printf "## QUALITY CHECK ##\n"
	printf "###################\033[0m \n"
	echo
	
	qualifastqc "${RAW_DATA}" "${FQC}"
	echo
	printf "Done!\n"
	date +"%T"
	exit 1

else
	echo
	printf "\033[1m\033[35mNOTE: Initial quality check will not be performed\033[0m\n"
fi



if [ "${RM}" == "BATCH" ]; then

	printf "\033[1m################################### \n"
	printf "## RUN CRISPResso2 in batch mode ##\n"
	printf "###################################\033[0m \n"
	echo

	run_crispresso_batch "${CPR}"

else 
	printf "\033[1m#####################\n"
	printf "## RUN CRISPResso2 ##\n"
	printf "#####################\033[0m \n"
	echo
	
	run_crispresso "${CPR}"

fi

echo ""
printf "\033[1m############# \n"
printf "\033[1;30;107m## THE END ##\033[0m\n"
printf "\033[1m#############\033[0m \n"
echo ""
date +"%T"
echo ""
